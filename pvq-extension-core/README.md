# PVQ Extension Core

<!-- generated by polka.codes -->

The foundational extension for the PVQ (PolkaVM Query) system, providing essential functionality and serving as the base for all other extensions. Every PVQ program has access to core extension features by default.

## Overview

The Core Extension provides fundamental capabilities that all PVQ guest programs need, including extension discovery, system information, and basic utility functions. It serves as the foundation layer that other extensions build upon.

## Features

- 🔍 **Extension Discovery**: Query available extensions at runtime
- ℹ️ **System Information**: Access runtime and execution environment details
- 🛠️ **Utility Functions**: Common operations needed by guest programs
- 🔒 **Security Primitives**: Basic security and validation functions
- 📊 **Metadata Access**: Extension and system metadata queries

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                  ExtensionCore                              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   Discovery     │  │   Utilities     │  │   Metadata   │ │
│  │                 │  │                 │  │              │ │
│  │ ├─ Extension    │  │ ├─ Hashing      │  │ ├─ System    │ │
│  │ │  Enumeration  │  │ ├─ Encoding     │  │ │  Info      │ │
│  │ ├─ Capability   │  │ ├─ Validation   │  │ ├─ Runtime   │ │
│  │ │  Checking     │  │ └─ Conversion   │  │ │  Version   │ │
│  │ └─ Version      │  │                 │  │ └─ Extension │ │
│  │    Matching     │  │                 │  │    Metadata │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## API Reference

### Extension Discovery

#### `extension_exists(name: &str) -> bool`

Checks if a specific extension is available in the current execution environment.

```rust
use pvq_extension_core::ExtensionCore;

// Check if fungibles extension is available
if ExtensionCore::extension_exists("fungibles") {
    // Use fungibles extension
} else {
    // Fallback logic
}
```

#### `list_extensions() -> Vec<String>`

Returns a list of all available extensions in the current environment.

```rust
use pvq_extension_core::ExtensionCore;

let available_extensions = ExtensionCore::list_extensions();
for extension in available_extensions {
    println!("Available: {}", extension);
}
```

#### `extension_version(name: &str) -> Option<String>`

Gets the version of a specific extension.

```rust
use pvq_extension_core::ExtensionCore;

if let Some(version) = ExtensionCore::extension_version("fungibles") {
    println!("Fungibles extension version: {}", version);
}
```

### System Information

#### `runtime_version() -> String`

Returns the runtime version information.

```rust
use pvq_extension_core::ExtensionCore;

let version = ExtensionCore::runtime_version();
println!("Runtime version: {}", version);
```

#### `execution_info() -> ExecutionInfo`

Provides information about the current execution environment.

```rust
use pvq_extension_core::{ExtensionCore, ExecutionInfo};

let info = ExtensionCore::execution_info();
println!("Max memory: {} bytes", info.max_memory);
println!("Execution timeout: {:?}", info.timeout);
```

### Utility Functions

#### `hash_blake2_256(data: &[u8]) -> [u8; 32]`

Computes Blake2 256-bit hash of the input data.

```rust
use pvq_extension_core::ExtensionCore;

let data = b"Hello, PVQ!";
let hash = ExtensionCore::hash_blake2_256(data);
println!("Hash: {:?}", hash);
```

#### `validate_account_id(account: &[u8]) -> bool`

Validates whether the provided bytes represent a valid account ID.

```rust
use pvq_extension_core::ExtensionCore;

let account = [1u8; 32];
if ExtensionCore::validate_account_id(&account) {
    println!("Valid account ID");
}
```

#### `current_block_number() -> u32`

Returns the current block number.

```rust
use pvq_extension_core::ExtensionCore;

let block_number = ExtensionCore::current_block_number();
println!("Current block: {}", block_number);
```

## Data Types

### ExecutionInfo

Information about the current execution environment:

```rust
pub struct ExecutionInfo {
    pub max_memory: u64,
    pub timeout: Duration,
    pub runtime_version: String,
    pub extensions_count: usize,
}
```

### ExtensionMetadata

Metadata for an extension:

```rust
pub struct ExtensionMetadata {
    pub name: String,
    pub version: String,
    pub description: String,
    pub functions: Vec<FunctionMetadata>,
}
```

## Usage Examples

### Basic Extension Check

```rust
use pvq_extension_core::ExtensionCore;

#[pvq_program::program]
fn my_query() -> String {
    if ExtensionCore::extension_exists("fungibles") {
        "Fungibles extension is available".to_string()
    } else {
        "Fungibles extension not found".to_string()
    }
}
```

### System Information Query

```rust
use pvq_extension_core::ExtensionCore;

#[pvq_program::program]
fn system_info() -> String {
    let runtime_version = ExtensionCore::runtime_version();
    let block_number = ExtensionCore::current_block_number();
    let extensions = ExtensionCore::list_extensions();
    
    format!(
        "Runtime: {}, Block: {}, Extensions: {:?}",
        runtime_version, block_number, extensions
    )
}
```

### Conditional Feature Usage

```rust
use pvq_extension_core::ExtensionCore;
use pvq_extension_fungibles::ExtensionFungibles;
use pvq_extension_swap::ExtensionSwap;

#[pvq_program::program]
fn advanced_query(asset_id: u32) -> String {
    let mut result = String::new();
    
    // Always available - core functionality
    let block = ExtensionCore::current_block_number();
    result.push_str(&format!("Block: {}\n", block));
    
    // Check for fungibles extension
    if ExtensionCore::extension_exists("fungibles") {
        let supply = ExtensionFungibles::total_supply(asset_id);
        result.push_str(&format!("Total Supply: {}\n", supply));
    }
    
    // Check for swap extension  
    if ExtensionCore::extension_exists("swap") {
        let pools = ExtensionSwap::list_pools();
        result.push_str(&format!("Available Pools: {}\n", pools.len()));
    }
    
    result
}
```

## Integration

### With Other Extensions

Core extension is automatically available and should be used by other extensions:

```rust
// In custom extension implementation
use pvq_extension_core::ExtensionCore;

impl MyExtension for MyExtensionImpl {
    fn my_function() -> bool {
        // Use core functionality
        let block = ExtensionCore::current_block_number();
        
        // Extension-specific logic
        block > 1000
    }
}
```

### Extension Development

When creating new extensions, leverage core utilities:

```rust
use pvq_extension_core::ExtensionCore;
use pvq_extension::extension_decl;

#[extension_decl]
pub trait MyCustomExtension {
    fn custom_query() -> String {
        // Use core hashing
        let data = b"custom data";
        let hash = ExtensionCore::hash_blake2_256(data);
        
        // Use system info
        let version = ExtensionCore::runtime_version();
        
        format!("Hash: {:?}, Version: {}", hash, version)
    }
}
```

## Configuration

### Runtime Configuration

Configure core extension behavior:

```rust
// In runtime configuration
impl pvq_extension_core::Config for Runtime {
    type MaxExtensionNameLength = ConstU32<32>;
    type MaxExtensionsCount = ConstU32<64>;
    type EnableDebugInfo = ConstBool<true>;
}
```

### Extension Registry

Register core extension in executor:

```rust
use pvq_extension::ExtensionsExecutor;
use pvq_extension_core::ExtensionCore;

let mut executor = ExtensionsExecutor::new();
executor.register::<ExtensionCore>();
```

## Development

### Building

```bash
# Build core extension
cargo build -p pvq-extension-core

# Run tests
cargo test -p pvq-extension-core

# Check documentation
cargo doc -p pvq-extension-core --open
```

### Testing

```bash
# Unit tests
cargo test -p pvq-extension-core

# Integration tests with executor
cargo test -p pvq-extension-core --test integration

# Test with guest programs
cargo run -p pvq-test-runner -- --program test-core-extension
```

## Security Considerations

- All core functions are safe and do not expose sensitive runtime internals
- Extension discovery is read-only and cannot modify system state
- Hash functions use cryptographically secure algorithms
- Account ID validation prevents invalid account access attempts

## Performance

### Optimization Tips

1. **Cache Extension List**: Extension discovery results can be cached
2. **Batch Queries**: Combine multiple core queries when possible
3. **Selective Checks**: Only check for extensions you actually need

### Benchmarks

```bash
# Run core extension benchmarks
cargo bench -p pvq-extension-core

# Profile extension discovery
cargo run --example profile_discovery --release
```

## Error Handling

Core extension functions are designed to be safe and rarely fail:

```rust
// Most functions return safe defaults
let extensions = ExtensionCore::list_extensions(); // Never fails

// Optional results for queries that might not have data
let version = ExtensionCore::extension_version("nonexistent"); // Returns None
```

## Related Components

- [PVQ Extension System](../pvq-extension/) - Extension framework
- [PVQ Fungibles Extension](../pvq-extension-fungibles/) - Asset functionality
- [PVQ Swap Extension](../pvq-extension-swap/) - DEX functionality
- [PVQ Executor](../pvq-executor/) - Execution environment

---

*The Core Extension provides the essential foundation for all PVQ program functionality.*