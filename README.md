# PVQ: PolkaVM Query System for Polkadot

<!-- generated by polka.codes -->

[![License](https://img.shields.io/badge/license-Apache%202.0-blue.svg)](LICENSE)
[![Rust](https://github.com/open-web3-stack/PVQ/workflows/Rust/badge.svg)](https://github.com/open-web3-stack/PVQ/actions)

A powerful and secure query system for Polkadot parachains that enables developers to write expressive, sandboxed guest programs using PolkaVM. PVQ provides a safe and efficient alternative to custom RPC endpoints for runtime data queries.

## âœ¨ Features

- **ğŸ”’ Secure Execution**: Sandboxed PolkaVM environment for safe query execution
- **ğŸ§© Modular Extensions**: Extensible system for exposing runtime functionalities
- **âš¡ High Performance**: Efficient RISC-V execution with minimal overhead
- **ğŸ› ï¸ Developer Friendly**: Rust-first development experience with procedural macros
- **ğŸŒ Runtime Integration**: Seamless integration with Substrate runtimes
- **ğŸ” Rich Querying**: Support for complex queries involving multiple runtime components

## ğŸ—ï¸ Architecture

The PVQ system consists of several interconnected components:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PVQ Program   â”‚â”€â”€â”€â–¶â”‚  PVQ Executor   â”‚â”€â”€â”€â–¶â”‚ Substrate       â”‚
â”‚  (Guest Code)   â”‚    â”‚   (Host Side)   â”‚    â”‚ Runtime         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ PVQ Extensions  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚   (Modules)     â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Core Components

| Component | Description |
|-----------|-------------|
| **[PVQ Program](pvq-program/)** | Guest programs written in Rust that compile to RISC-V |
| **[PVQ Executor](pvq-executor/)** | Host-side component managing PolkaVM instances and runtime interaction |
| **[PVQ Extensions](pvq-extension/)** | Modular system exposing runtime functionalities to guest programs |
| **[PVQ Runtime API](pvq-runtime-api/)** | Substrate runtime API for external query submission |
| **[PVQ Primitives](pvq-primitives/)** | Common types and utilities shared across components |

### Available Extensions

- **[Core Extension](pvq-extension-core/)**: Fundamental functionalities and extension discovery
- **[Fungibles Extension](pvq-extension-fungibles/)**: Asset querying, balances, and metadata
- **[Swap Extension](pvq-extension-swap/)**: DEX interactions, liquidity pools, and price quotes

## ğŸš€ Getting Started

### Prerequisites

Ensure you have the following installed:

- **Rust** (latest stable version)
- **Git** with submodule support

### Installation

1. **Clone the repository with submodules:**
   ```bash
   git clone --recursive https://github.com/open-web3-stack/PVQ.git
   cd PVQ
   ```

2. **Install required tools:**
   ```bash
   make tools
   ```
   This installs `polkatool` for ELF to PolkaVM blob conversion and `chain-spec-builder`.

3. **Build the project:**
   ```bash
   cargo build --release
   ```

### Quick Start

#### Running Example Programs

1. **Build guest programs:**
   ```bash
   make guests
   ```

2. **Run a test program:**
   ```bash
   cargo run -p pvq-test-runner -- --program output/guest-sum-balance
   ```

#### Available Example Programs

| Program | Description |
|---------|-------------|
| `guest-sum-balance` | Sum balances of multiple accounts |
| `guest-total-supply` | Get total supply of an asset |
| `guest-sum-balance-percent` | Calculate percentage of total supply for account balances |
| `guest-swap-info` | Query DEX/swap information |

### Runtime Integration

#### Testing with PoC Runtime

1. **Start local test chain:**
   ```bash
   make run
   ```

2. **Build and test programs:**
   ```bash
   make guests
   cargo run -p pvq-test-runner -- --program output/guest-total-supply
   ```

3. **Use with Polkadot JS UI:**
   - Copy the hex-encoded `args` from test runner logs
   - Upload program and arguments through the PJS UI

## ğŸ“– Documentation

### Writing Your First PVQ Program

```rust
use pvq_program::program;
use pvq_extension_fungibles::ExtensionFungibles;

#[program]
fn query_balance(account: [u8; 32], asset_id: u32) -> u128 {
    ExtensionFungibles::balance(asset_id, &account)
}
```

### Creating Custom Extensions

```rust
use pvq_extension::extension_decl;

#[extension_decl]
pub trait MyCustomExtension {
    fn my_query() -> String;
}
```

### Component Documentation

- ğŸ“š **[Development Guide](docs/development.md)** - Comprehensive development setup
- ğŸ”§ **[Extension Development](docs/extensions.md)** - Creating custom extensions
- ğŸ—ï¸ **[Architecture Deep Dive](docs/architecture.md)** - System design and internals
- ğŸ“‹ **[API Reference](docs/api.md)** - Complete API documentation

## ğŸ› ï¸ Development

### Project Structure

```
PVQ/
â”œâ”€â”€ poc/runtime/              # PoC Substrate runtime
â”œâ”€â”€ pvq-program/              # Program macro and utilities
â”œâ”€â”€ pvq-executor/             # Core execution engine
â”œâ”€â”€ pvq-extension*/           # Extension system and implementations
â”œâ”€â”€ pvq-runtime-api/          # Runtime API definition
â”œâ”€â”€ pvq-test-runner/          # Testing utilities
â”œâ”€â”€ guest-examples/           # Example programs
â””â”€â”€ vendor/polkavm/           # Vendored PolkaVM dependency
```

### Building from Source

```bash
# Development build
cargo build

# Release build with optimizations
cargo build --release

# Build guest examples
make guests

# Run all tests
cargo test --all

# Run clippy lints
cargo clippy --all --all-targets
```

### Testing

```bash
# Run unit tests
cargo test

# Run integration tests
cargo test --test integration

# Test specific component
cargo test -p pvq-executor

# Run example programs
make test-guests
```
