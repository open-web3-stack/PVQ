# PVQ Extension Fungibles

<!-- generated by polka.codes -->

A powerful extension for the PVQ (PolkaVM Query) system that enables guest programs to query fungible asset information from the runtime. This extension provides comprehensive access to asset balances, metadata, and supply information.

## Overview

The Fungibles Extension integrates with Substrate's assets pallet and native balance systems to provide PVQ guest programs with read-only access to fungible token data. It supports both native tokens and custom assets created through the assets pallet.

## Features

- 💰 **Balance Queries**: Get account balances for any asset
- 📊 **Supply Information**: Query total supply and supply metrics
- ℹ️ **Asset Metadata**: Access asset names, symbols, and decimals
- 🔍 **Asset Discovery**: List and enumerate available assets
- 🏦 **Multi-Asset Support**: Native tokens and custom assets
- ⚡ **Efficient Queries**: Optimized for high-performance data access

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                ExtensionFungibles                           │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │    Balances     │  │     Assets      │  │   Metadata   │ │
│  │                 │  │                 │  │              │ │
│  │ ├─ Account      │  │ ├─ Total Supply │  │ ├─ Name      │ │
│  │ │  Balance      │  │ ├─ Minimum      │  │ ├─ Symbol    │ │
│  │ ├─ Free         │  │ │  Balance      │  │ ├─ Decimals  │ │
│  │ │  Balance      │  │ ├─ Asset Exists │  │ └─ Custom    │ │
│  │ ├─ Reserved     │  │ └─ Asset List   │  │    Fields    │ │
│  │ │  Balance      │  │                 │  │              │ │
│  │ └─ Locked       │  │                 │  │              │ │
│  │    Balance      │  │                 │  │              │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## API Reference

### Balance Operations

#### `balance(asset_id: u32, account: &[u8; 32]) -> u128`

Get the total balance (free + reserved) of an account for a specific asset.

```rust
use pvq_extension_fungibles::ExtensionFungibles;

#[pvq_program::program]  
fn get_account_balance(asset_id: u32, account: [u8; 32]) -> u128 {
    ExtensionFungibles::balance(asset_id, &account)
}
```

#### `balance_free(asset_id: u32, account: &[u8; 32]) -> u128`

Get the free (transferable) balance of an account.

```rust
use pvq_extension_fungibles::ExtensionFungibles;

let free_balance = ExtensionFungibles::balance_free(asset_id, &account);
println!("Free balance: {}", free_balance);
```

#### `balance_reserved(asset_id: u32, account: &[u8; 32]) -> u128`

Get the reserved (non-transferable) balance of an account.

```rust  
use pvq_extension_fungibles::ExtensionFungibles;

let reserved_balance = ExtensionFungibles::balance_reserved(asset_id, &account);
println!("Reserved balance: {}", reserved_balance);
```

### Asset Information

#### `total_supply(asset_id: u32) -> u128`

Get the total supply of an asset.

```rust
use pvq_extension_fungibles::ExtensionFungibles;

#[pvq_program::program]
fn asset_total_supply(asset_id: u32) -> u128 {
    ExtensionFungibles::total_supply(asset_id)
}
```

#### `minimum_balance(asset_id: u32) -> u128`

Get the minimum balance required to maintain an account.

```rust
use pvq_extension_fungibles::ExtensionFungibles;

let min_balance = ExtensionFungibles::minimum_balance(asset_id);
println!("Minimum balance: {}", min_balance);
```

#### `asset_exists(asset_id: u32) -> bool`

Check if an asset exists in the runtime.

```rust
use pvq_extension_fungibles::ExtensionFungibles;

if ExtensionFungibles::asset_exists(asset_id) {
    // Asset is valid
    let supply = ExtensionFungibles::total_supply(asset_id);
} else {
    // Asset doesn't exist
}
```

### Asset Discovery

#### `list_assets() -> Vec<u32>`

Get a list of all available asset IDs.

```rust
use pvq_extension_fungibles::ExtensionFungibles;

#[pvq_program::program]
fn available_assets() -> Vec<u32> {
    ExtensionFungibles::list_assets()
}
```

#### `asset_count() -> u32`

Get the total number of assets in the system.

```rust
use pvq_extension_fungibles::ExtensionFungibles;

let count = ExtensionFungibles::asset_count();
println!("Total assets: {}", count);
```

### Metadata Operations

#### `asset_metadata(asset_id: u32) -> Option<AssetMetadata>`

Get complete metadata for an asset.

```rust
use pvq_extension_fungibles::{ExtensionFungibles, AssetMetadata};

if let Some(metadata) = ExtensionFungibles::asset_metadata(asset_id) {
    println!("Name: {}", metadata.name);
    println!("Symbol: {}", metadata.symbol);
    println!("Decimals: {}", metadata.decimals);
}
```

#### `asset_name(asset_id: u32) -> Option<String>`

Get the name of an asset.

```rust
use pvq_extension_fungibles::ExtensionFungibles;

if let Some(name) = ExtensionFungibles::asset_name(asset_id) {
    println!("Asset name: {}", name);
}
```

#### `asset_symbol(asset_id: u32) -> Option<String>`

Get the symbol of an asset.

```rust
use pvq_extension_fungibles::ExtensionFungibles;

if let Some(symbol) = ExtensionFungibles::asset_symbol(asset_id) {
    println!("Asset symbol: {}", symbol);
}
```

#### `asset_decimals(asset_id: u32) -> Option<u8>`

Get the decimal precision of an asset.

```rust
use pvq_extension_fungibles::ExtensionFungibles;

if let Some(decimals) = ExtensionFungibles::asset_decimals(asset_id) {
    println!("Asset decimals: {}", decimals);
}
```

## Data Types

### AssetMetadata

Complete asset metadata information:

```rust
pub struct AssetMetadata {
    pub name: String,
    pub symbol: String, 
    pub decimals: u8,
    pub is_frozen: bool,
}
```

### BalanceInfo

Comprehensive balance information:

```rust
pub struct BalanceInfo {
    pub free: u128,
    pub reserved: u128,
    pub frozen: u128,
}
```

## Usage Examples

### Basic Balance Query

```rust
use pvq_extension_fungibles::ExtensionFungibles;

#[pvq_program::program]
fn check_balance(asset_id: u32, account: [u8; 32]) -> String {
    let balance = ExtensionFungibles::balance(asset_id, &account);
    
    if balance == 0 {
        "Account has no balance".to_string()
    } else {
        format!("Balance: {}", balance)
    }
}
```

### Multi-Account Balance Sum

```rust
use pvq_extension_fungibles::ExtensionFungibles;

#[pvq_program::program]
fn sum_balances(asset_id: u32, accounts: Vec<[u8; 32]>) -> u128 {
    accounts.iter()
        .map(|account| ExtensionFungibles::balance(asset_id, account))
        .sum()
}
```

### Asset Analysis

```rust
use pvq_extension_fungibles::{ExtensionFungibles, AssetMetadata};

#[pvq_program::program]
fn analyze_asset(asset_id: u32) -> String {
    if !ExtensionFungibles::asset_exists(asset_id) {
        return "Asset does not exist".to_string();
    }
    
    let supply = ExtensionFungibles::total_supply(asset_id);
    let min_balance = ExtensionFungibles::minimum_balance(asset_id);
    
    let metadata = ExtensionFungibles::asset_metadata(asset_id);
    
    match metadata {
        Some(meta) => {
            format!(
                "Asset {}: {} ({}) - Supply: {}, Min Balance: {}, Decimals: {}",
                asset_id, meta.name, meta.symbol, supply, min_balance, meta.decimals
            )
        }
        None => {
            format!(
                "Asset {}: No metadata - Supply: {}, Min Balance: {}",
                asset_id, supply, min_balance
            )
        }
    }
}
```

### Portfolio Tracker

```rust
use pvq_extension_fungibles::ExtensionFungibles;

#[pvq_program::program]
fn portfolio_value(account: [u8; 32]) -> Vec<(u32, u128)> {
    let assets = ExtensionFungibles::list_assets();
    let mut portfolio = Vec::new();
    
    for asset_id in assets {
        let balance = ExtensionFungibles::balance(asset_id, &account);
        if balance > 0 {
            portfolio.push((asset_id, balance));
        }
    }
    
    portfolio
}
```

### Percentage of Total Supply

```rust
use pvq_extension_fungibles::ExtensionFungibles;

#[pvq_program::program]
fn balance_percentage(asset_id: u32, account: [u8; 32]) -> f64 {
    let balance = ExtensionFungibles::balance(asset_id, &account);
    let total_supply = ExtensionFungibles::total_supply(asset_id);
    
    if total_supply == 0 {
        0.0
    } else {
        (balance as f64 / total_supply as f64) * 100.0
    }
}
```

## Integration

### With Runtime

Configure the fungibles extension in your runtime:

```rust
// In runtime configuration
impl pvq_extension_fungibles::Config for Runtime {
    type AssetId = u32;
    type Balance = u128;
    type AssetRegistry = Assets;
    type NativeBalance = Balances;
}
```

### With Extension Executor

Register the fungibles extension:

```rust
use pvq_extension::ExtensionsExecutor;
use pvq_extension_fungibles::ExtensionFungibles;

let mut executor = ExtensionsExecutor::new();
executor.register::<ExtensionFungibles>();
```

### Error Handling

Handle potential query failures:

```rust
use pvq_extension_fungibles::ExtensionFungibles;

#[pvq_program::program]
fn safe_balance_query(asset_id: u32, account: [u8; 32]) -> String {
    if !ExtensionFungibles::asset_exists(asset_id) {
        return "Asset not found".to_string();
    }
    
    let balance = ExtensionFungibles::balance(asset_id, &account);
    format!("Balance: {}", balance)
}
```

## Configuration

### Asset ID Types

Support different asset ID types:

```rust
impl pvq_extension_fungibles::Config for Runtime {
    // For simple numeric IDs
    type AssetId = u32;
    
    // For complex asset identifiers  
    type AssetId = AssetIdOf<Self>;
}
```

### Balance Types

Configure balance precision:

```rust
impl pvq_extension_fungibles::Config for Runtime {
    // Standard 128-bit balance
    type Balance = u128;
    
    // Custom balance type
    type Balance = BalanceOf<Self>;
}
```

## Development

### Building

```bash
# Build fungibles extension
cargo build -p pvq-extension-fungibles

# Run tests
cargo test -p pvq-extension-fungibles

# Generate documentation  
cargo doc -p pvq-extension-fungibles --open
```

### Testing

```bash
# Unit tests
cargo test -p pvq-extension-fungibles

# Integration tests with runtime
cargo test -p pvq-extension-fungibles --test runtime_integration

# Test with guest programs
cargo run -p pvq-test-runner -- --program test-fungibles
```

### Benchmarking

```bash
# Run performance benchmarks
cargo bench -p pvq-extension-fungibles

# Profile balance queries
cargo run --example profile_queries --release
```

## Performance Considerations

### Optimization Tips

1. **Batch Queries**: Query multiple balances in a single program
2. **Asset Filtering**: Use `asset_exists()` before expensive operations
3. **Cache Metadata**: Store frequently accessed metadata
4. **Selective Fields**: Only query the specific data you need

### Query Patterns

```rust
// Efficient: Single program, multiple accounts
#[pvq_program::program] 
fn efficient_multi_balance(asset_id: u32, accounts: Vec<[u8; 32]>) -> Vec<u128> {
    accounts.iter()
        .map(|account| ExtensionFungibles::balance(asset_id, account))
        .collect()
}

// Less efficient: Multiple program calls
// Don't do this - call the program once with all accounts
```

## Security Considerations

- All functions are read-only and cannot modify balances
- Account data access is controlled by the runtime
- Asset existence checks prevent invalid asset queries
- No sensitive runtime internals are exposed

## Common Use Cases

### DeFi Applications

```rust
// Calculate liquidity pool ratios
#[pvq_program::program]
fn pool_ratio(token_a: u32, token_b: u32, pool_account: [u8; 32]) -> (u128, u128) {
    let balance_a = ExtensionFungibles::balance(token_a, &pool_account);
    let balance_b = ExtensionFungibles::balance(token_b, &pool_account);
    (balance_a, balance_b)
}
```

### Analytics

```rust
// Top holders analysis
#[pvq_program::program]
fn top_holders_share(asset_id: u32, holders: Vec<[u8; 32]>) -> f64 {
    let total_supply = ExtensionFungibles::total_supply(asset_id);
    let holders_balance: u128 = holders.iter()
        .map(|account| ExtensionFungibles::balance(asset_id, account))
        .sum();
        
    (holders_balance as f64 / total_supply as f64) * 100.0
}
```

## Related Components

- [PVQ Extension System](../pvq-extension/) - Extension framework  
- [PVQ Extension Core](../pvq-extension-core/) - Core functionality
- [PVQ Extension Swap](../pvq-extension-swap/) - DEX functionality
- [PVQ Runtime API](../pvq-runtime-api/) - Runtime integration

---

*The Fungibles Extension provides comprehensive access to asset and balance data for PVQ programs.*